

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Prepare Data &mdash; MAMMOTH  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]]}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Training MAMMOTH 101" href="examples/train_mammoth_101.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> MAMMOTH
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="main.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="ref.html">References</a></li>
</ul>
<p class="caption"><span class="caption-text">Frequently Asked Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">About MAMMOTH</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html#mammoth-and-opennmt">MAMMOTH and OpenNMT</a></li>
</ul>
<p class="caption"><span class="caption-text">MAMMOTH features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modular_model.html">Component-level Modularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_config.html">Config-config Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="attention_bridges.html">Attention Bridge</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Prepare Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quickstart-europarl">Quickstart: Europarl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-download-the-data">Step 1: Download the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-tokenization">Step 2: Tokenization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#unpc">UNPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#opus-100">OPUS 100</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-set-relevant-paths-variables-and-download">Step 1: Set relevant paths, variables and download</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-train-sentencepiece-models-and-get-vocabs">Step 2: Train SentencePiece models and get vocabs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-parse-train-valid-and-test-sets-for-supervised-translation-directions">Step 3: Parse train, valid and test sets for supervised translation directions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-parse-the-test-sets-for-zero-shot-translation-directions">Step 4: Parse the test sets for zero-shot translation directions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples/train_mammoth_101.html">Training MAMMOTH 101</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/sharing_schemes.html">MAMMOTH Sharing Schemes</a></li>
</ul>
<p class="caption"><span class="caption-text">Scripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="options/build_vocab.html">Build Vocab</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/train.html">Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/translate.html">Translate</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/server.html">Server</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mammoth.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="mammoth.modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="mammoth.translation.html">Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mammoth.translate.translation_server.html">Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="mammoth.inputters.html">Data Loaders</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MAMMOTH</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Prepare Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/prepare_data.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="prepare-data">
<h1>Prepare Data<a class="headerlink" href="#prepare-data" title="Permalink to this headline">¶</a></h1>
<p>Before running these scripts, make sure that you have <a class="reference internal" href="quickstart.html"><span class="doc">installed</span></a> Mamooth, which includes the dependencies required below.</p>
<div class="section" id="quickstart-europarl">
<h2>Quickstart: Europarl<a class="headerlink" href="#quickstart-europarl" title="Permalink to this headline">¶</a></h2>
<p>In the <a class="reference internal" href="quickstart.html"><span class="doc">Quickstart tutorial</span></a>, we assume that you will download and preprocess the Europarl data by following the steps below.</p>
<div class="section" id="step-1-download-the-data">
<h3>Step 1: Download the data<a class="headerlink" href="#step-1-download-the-data" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.statmt.org/europarl/">Europarl parallel corpus</a> is a multilingual resource extracted from European Parliament proceedings and contains texts in 21 European languages. Download the Release v7 - a further expanded and improved version of the Europarl corpus on 15 May 2012 - from the original website or
download the processed data by us:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>https://mammoth101.a3s.fi/europarl.tar.gz
mkdir<span class="w"> </span>europarl_data
tar<span class="w"> </span>–xvzf<span class="w"> </span>europarl.tar.gz<span class="w"> </span>-C<span class="w"> </span>europarl_data
</pre></div>
</div>
<p>Note that the extracted dataset will require around 30GB of memory. Alternatively, you can only download the data for the three example languages (666M).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>https://mammoth101.a3s.fi/europarl-3langs.tar.gz
mkdir<span class="w"> </span>europarl_data
tar<span class="w"> </span>–xvzf<span class="w"> </span>europarl-3langs.tar.gz<span class="w"> </span>-C<span class="w"> </span>europarl_data
</pre></div>
</div>
<p>We use a SentencePiece tokenizer trained on OPUS Tatoeba Challenge data with 64k vocabulary size. Download the SentencePiece model and the vocabulary:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download the SentencePiece model</span>
wget<span class="w"> </span>https://mammoth101.a3s.fi/opusTC.mul.64k.spm
<span class="c1"># Download the vocabulary</span>
wget<span class="w"> </span>https://mammoth101.a3s.fi/opusTC.mul.vocab.onmt

mkdir<span class="w"> </span>vocab
mv<span class="w"> </span>opusTC.mul.64k.spm<span class="w"> </span>vocab/.
mv<span class="w"> </span>opusTC.mul.vocab.onmt<span class="w"> </span>vocab/.
</pre></div>
</div>
<p>If you would like to create and use a custom sentencepiece tokenizer, take a look at the OPUS tutorial below.</p>
</div>
<div class="section" id="step-2-tokenization">
<h3>Step 2: Tokenization<a class="headerlink" href="#step-2-tokenization" title="Permalink to this headline">¶</a></h3>
<p>Then, read parallel text data, processes it, and generates output files for training and validation sets.
Here’s a high-level summary of the main processing steps. For each language in ‘langs,’</p>
<ul class="simple">
<li><p>read parallel data files.</p></li>
<li><p>clean the data by removing empty lines.</p></li>
<li><p>shuffle the data randomly.</p></li>
<li><p>tokenizes the text using SentencePiece and writes the tokenized data to separate output files for training and validation sets.</p></li>
</ul>
<p>You’re free to skip this step if you directly download the processed data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">sentencepiece</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">,</span> <span class="s2">&quot;cs&quot;</span><span class="p">]</span>

<span class="n">sp_path</span> <span class="o">=</span> <span class="s1">&#39;vocab/opusTC.mul.64k.spm&#39;</span>
<span class="n">spm</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">SentencePieceProcessor</span><span class="p">(</span><span class="n">model_file</span><span class="o">=</span><span class="n">sp_path</span><span class="p">)</span>

<span class="n">input_dir</span> <span class="o">=</span> <span class="s1">&#39;europarl_data/europarl&#39;</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;europarl_data/encoded&#39;</span>

<span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">langs</span><span class="p">):</span>
    <span class="n">en_side_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en/europarl-v7.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en.en&#39;</span>
    <span class="n">xx_side_in</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en/europarl-v7.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xx_side_in</span><span class="p">)</span> <span class="k">as</span> <span class="n">xx_stream</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">en_side_in</span><span class="p">)</span> <span class="k">as</span> <span class="n">en_stream</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">xx_stream</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">en_stream</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">xx</span><span class="p">,</span> <span class="n">en</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;read </span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">xx</span> <span class="ow">and</span> <span class="n">en</span><span class="p">]</span> <span class="c1"># drop empty lines</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="n">en_side_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/valid.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en.en.sp&#39;</span>
    <span class="n">xx_side_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/valid.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.sp&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xx_side_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xx_stream</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">en_side_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">en_stream</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;valid </span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">spm</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">xx_stream</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">spm</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">en_stream</span><span class="p">)</span>
    <span class="n">en_side_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/train.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en.en.sp&#39;</span>
    <span class="n">xx_side_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/train.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">-en.</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.sp&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xx_side_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xx_stream</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">en_side_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">en_stream</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1000</span><span class="p">:],</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;train </span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">spm</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">xx_stream</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">spm</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">en_stream</span><span class="p">)</span>
</pre></div>
</div>
<p>The script will produce encoded datasets in <code class="docutils literal notranslate"><span class="pre">europarl_data/encoded</span></code> that you can further use for the training.</p>
</div>
</div>
<div class="section" id="unpc">
<h2>UNPC<a class="headerlink" href="#unpc" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://opus.nlpl.eu/UNPC/corpus/version/UNPC">UNPC</a> consists of manually translated UN documents from the last 25 years (1990 to 2014) for the six official UN languages, Arabic, Chinese, English, French, Russian, and Spanish.
We preprocess the data. You can download the processed data by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>https://mammoth-share.a3s.fi/unpc.tar
</pre></div>
</div>
<p>Or you can use the scripts provided by the tarball to process the data yourself.</p>
<p>For references, please cite this reference: Ziemski, M., Junczys-Dowmunt, M., and Pouliquen, B., (2016), The United Nations Parallel Corpus, Language Resources and Evaluation (LREC’16), Portorož, Slovenia, May 2016.</p>
</div>
<div class="section" id="opus-100">
<h2>OPUS 100<a class="headerlink" href="#opus-100" title="Permalink to this headline">¶</a></h2>
<p>In this guideline, we will also create our custom sentencepiece tokenizer.</p>
<p>To do that, you will also need to compile a sentencepiece installation in your environment (not just pip install).
Follow the instructions on <a class="reference external" href="https://github.com/google/sentencepiece?tab=readme-ov-file#build-and-install-sentencepiece-command-line-tools-from-c-source">sentencepiece github</a>.</p>
<p>After that, download the opus 100 dataset from <a class="reference external" href="https://opus.nlpl.eu/legacy/opus-100.php">OPUS 100</a></p>
<div class="section" id="step-1-set-relevant-paths-variables-and-download">
<h3>Step 1: Set relevant paths, variables and download<a class="headerlink" href="#step-1-set-relevant-paths-variables-and-download" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SP_PATH=your/sentencepiece/path/build/src
DATA_PATH=your/path/to/save/dataset
# Download the default datasets into the $DATA_PATH; mkdir if it doesn&#39;t exist
mkdir -p $DATA_PATH

CUR_DIR=$(pwd)

# set vocabulary size and language pairs
vocab_sizes=(32000 16000 8000 4000 2000 1000)
input_sentence_size=10000000

cd $DATA_PATH
echo &quot;Downloading and extracting Opus100&quot;
wget -q --trust-server-names https://object.pouta.csc.fi/OPUS-100/v1.0/opus-100-corpus-v1.0.tar.gz
tar -xzvf opus-100-corpus-v1.0.tar.gz
cd $CUR_DIR

language_pairs=( $( ls $DATA_PATH/opus-100-corpus/v1.0/supervised/ ) )
</pre></div>
</div>
</div>
<div class="section" id="step-2-train-sentencepiece-models-and-get-vocabs">
<h3>Step 2: Train SentencePiece models and get vocabs<a class="headerlink" href="#step-2-train-sentencepiece-models-and-get-vocabs" title="Permalink to this headline">¶</a></h3>
<p>Starting from here, original files are supposed to be in <code class="docutils literal notranslate"><span class="pre">$DATA_PATH</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo &quot;$0: Training SentencePiece models&quot;
rm -f $DATA_PATH/train.txt
rm -f $DATA_PATH/train.en.txt
for lp in &quot;${language_pairs[@]}&quot;
do
IFS=- read sl tl &lt;&lt;&lt; $lp
if [[ $sl = &quot;en&quot; ]]
then
other_lang=$tl
else
other_lang=$sl
fi
# train the SentencePiece model over the language other than english
sort -u $DATA_PATH/opus-100-corpus/v1.0/supervised/$lp/opus.$lp-train.$other_lang | shuf &gt; $DATA_PATH/train.txt
for vocab_size in &quot;${vocab_sizes[@]}&quot;
do
echo &quot;Training SentencePiece model for $other_lang with vocab size $vocab_size&quot;
cd $SP_PATH
./spm_train --input=$DATA_PATH/train.txt \
            --model_prefix=$DATA_PATH/opus.$other_lang \
            --vocab_size=$vocab_size --character_coverage=0.98 \
            --input_sentence_size=$input_sentence_size --shuffle_input_sentence=true # to use a subset of sentences sampled from the entire training set
cd $CUR_DIR
if [ -f &quot;$DATA_PATH&quot;/opus.&quot;$other_lang&quot;.vocab ]
then
    # get vocab in onmt format
    cut -f 1 &quot;$DATA_PATH&quot;/opus.&quot;$other_lang&quot;.vocab &gt; &quot;$DATA_PATH&quot;/opus.&quot;$other_lang&quot;.vocab.onmt
    break
fi
done
rm $DATA_PATH/train.txt
# append the english data to a file
cat $DATA_PATH/opus-100-corpus/v1.0/supervised/$lp/opus.$lp-train.en &gt;&gt; $DATA_PATH/train.en.txt

 # train the SentencePiece model for english
 echo &quot;Training SentencePiece model for en&quot;
 sort -u $DATA_PATH/train.en.txt | shuf -n $input_sentence_size &gt; $DATA_PATH/train.txt
 rm $DATA_PATH/train.en.txt
 cd $SP_PATH
 ./spm_train --input=$DATA_PATH/train.txt --model_prefix=$DATA_PATH/opus.en \
             --vocab_size=${vocab_sizes[0]} --character_coverage=0.98 \
             --input_sentence_size=$input_sentence_size --shuffle_input_sentence=true # to use a subset of sentences sampled from the entire training set
# Other options to consider:
# --max_sentence_length=  # to set max length when filtering sentences
# --train_extremely_large_corpus=true
 cd $CUR_DIR
 rm $DATA_PATH/train.txt
fi
</pre></div>
</div>
</div>
<div class="section" id="step-3-parse-train-valid-and-test-sets-for-supervised-translation-directions">
<h3>Step 3: Parse train, valid and test sets for supervised translation directions<a class="headerlink" href="#step-3-parse-train-valid-and-test-sets-for-supervised-translation-directions" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p $DATA_PATH/supervised
for lp in &quot;${language_pairs[@]}&quot;
do
mkdir -p $DATA_PATH/supervised/$lp
IFS=- read sl tl &lt;&lt;&lt; $lp

echo &quot;$lp: parsing train data&quot;
dir=$DATA_PATH/opus-100-corpus/v1.0/supervised
cd $SP_PATH
./spm_encode --model=$DATA_PATH/opus.$sl.model \
                &lt; $dir/$lp/opus.$lp-train.$sl \
                &gt; $DATA_PATH/supervised/$lp/opus.$lp-train.$sl.sp
./spm_encode --model=$DATA_PATH/opus.$tl.model \
                &lt; $dir/$lp/opus.$lp-train.$tl \
                &gt; $DATA_PATH/supervised/$lp/opus.$lp-train.$tl.sp
cd $CUR_DIR

if [ -f $dir/$lp/opus.$lp-dev.$sl ]
then
    echo &quot;$lp: parsing dev data&quot;
    cd $SP_PATH
    ./spm_encode --model=$DATA_PATH/opus.$sl.model \
                &lt; $dir/$lp/opus.$lp-dev.$sl \
                &gt; $DATA_PATH/supervised/$lp/opus.$lp-dev.$sl.sp
    ./spm_encode --model=$DATA_PATH/opus.$tl.model \
                &lt; $dir/$lp/opus.$lp-dev.$tl \
                &gt; $DATA_PATH/supervised/$lp/opus.$lp-dev.$tl.sp
    cd $CUR_DIR
else
    echo &quot;$lp: dev data not found&quot;
fi

if [ -f $dir/$lp/opus.$lp-test.$sl ]
then
    echo &quot;$lp: parsing test data&quot;
    cd $SP_PATH
    ./spm_encode --model=$DATA_PATH/opus.$sl.model \
                &lt; $dir/$lp/opus.$lp-test.$sl \
                &gt; $DATA_PATH/supervised/$lp/opus.$lp-test.$sl.sp
    ./spm_encode --model=$DATA_PATH/opus.$tl.model \
                &lt; $dir/$lp/opus.$lp-test.$tl \
                &gt; $DATA_PATH/supervised/$lp/opus.$lp-test.$tl.sp
    cd $CUR_DIR
else
    echo &quot;$lp: test data not found&quot;
fi
done
</pre></div>
</div>
</div>
<div class="section" id="step-4-parse-the-test-sets-for-zero-shot-translation-directions">
<h3>Step 4: Parse the test sets for zero-shot translation directions<a class="headerlink" href="#step-4-parse-the-test-sets-for-zero-shot-translation-directions" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p $DATA_PATH/zero-shot
for dir in $DATA_PATH/opus-100-corpus/v1.0/zero-shot/*
do
lp=$(basename $dir)  # get name of dir from full path
mkdir -p $DATA_PATH/zero-shot/$lp
echo &quot;$lp: parsing zero-shot test data&quot;
IFS=- read sl tl &lt;&lt;&lt; $lp
cd $SP_PATH
./spm_encode --model=$DATA_PATH/opus.$sl.model \
            &lt; $dir/opus.$lp-test.$sl \
            &gt; $DATA_PATH/zero-shot/$lp/opus.$lp-test.$sl.sp
./spm_encode --model=$DATA_PATH/opus.$tl.model \
            &lt; $dir/opus.$lp-test.$tl \
            &gt; $DATA_PATH/zero-shot/$lp/opus.$lp-test.$tl.sp
cd $CUR_DIR
done
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="examples/train_mammoth_101.html" class="btn btn-neutral float-right" title="Training MAMMOTH 101" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, HelsinkiNLP

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>